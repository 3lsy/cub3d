name: Leak Tests

on:
  push:
    paths:
      - 'src/**'
      - 'include/**'
      - 'lib/libft/**'
      - 'maps/**'
      - 'textures/**'
  workflow_dispatch:
jobs:
  leak-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Install dependencies
        run: |
          DEBIAN_FRONTEND=noninteractive sudo apt-get update \
            && sudo DEBIAN_FRONTEND=noninteractive \
            apt-get -y install valgrind xorg \
            libxext-dev zlib1g-dev libbsd-dev make clang

      - name: Build cub3d
        run: make

      - name: Leak test
        run: |
          for map in maps/{valid,invalid}/*.cub; do
            echo "Testing $map..."

            # Run Valgrind to check for memory leaks
            valmessage=$(valgrind ./cub3d "$map" 2>&1 || true)

            # Check for the "no leaks are possible" message
            leaks=$(echo "$valmessage" | grep 'no leaks are possible' || true)

            if [ -n "$leaks" ]; then
              echo "No leaks for $map! âœ…ğŸ”¥"
            else
              echo "Errors for $map:"
              echo "$valmessage"
              echo "Leaks FAILURE for $map! ğŸ˜âŒ"
            fi
          done
